<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
    <title>Basic Example</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    
    <!-- Bootstrap Select CSS and JS files-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/bootstrap-select.min.js"></script>
    
    <!-- Geocoder-js from Github-->
    <script src="Packages/geocoder.js"></script>
    
  <style>
	  body { 
	    margin: 0; 
	    padding: 0; 
	    font-family: Helvetica, sans-serif;
	  }
	  #map {
	    position: absolute;
	    top: 0;
	    bottom: 0;
	    left: 0;
	    width: 70%;
	  }
	
	.info {
	    padding: 6px 8px;
	    font: 14px/16px Arial, Helvetica, sans-serif;
	    background: white;
	    background: rgba(255,255,255,0.85);
	    box-shadow: 0 0 15px rgba(0,0,0,0.5);
	    border-radius: 5px;
		pointer-events: auto;
	}
	.info h4 {
	    margin: 0 0 4px;
	    color: #000;
	}
    .selection_menu {
        position: absolute;
        right: 0px;
        width: 30%;
    }
    
   .first_search {
        position: relative;
        left: 20px;
    }
    
  </style>
</head>
<body>
  <div id='map'></div>
  <div class = "selection_menu">
  <div class="first_search">
  <b> Select Project Attributes </b>
  
  <form id ='unit_bounds'>
      Minimum Units:<input type='text' value = ''></input>
      </br>Maximimum Units:<input type='text' value = ''></input>
  </form>

  Project Status: <select class="selectpicker" data-live-search="true" id = "statusSelect">
         <optgroup label="Currently Proposed (Q1 2017)">
         <option data-tokens="All" value = "All">All</option>
         <option data-tokens="Under Construction" value = "CONSTRUCTION">Under Construction</option>
         <option data-tokens="PL Approved" value = "PL APPROVED">PL Approved</option>
         <option data-tokens="PL Filed" value = "PL FILED">PL Filed</option>
         <option data-tokens="BP Issued" value = "BP ISSUED">BP Issued</option>
         <option data-tokens="BP Approved" value = "BP APPROVED">BP Approved</option>
         <option data-tokens="BP Filed" value = "BP FILED">BP Filed</option>
         <option data-tokens="BP Reinstated" value = "BP REINSTATED">BP Reinstated</option>
         </optgroup>
     </select> </br>
  </br>
  <b> Search by Place </b>
  </br>
  <select class="selectpicker" data-live-search="true" id = "placeSelect">
    <option data-tokens="All" value = "All">All</option>
    <optgroup label="Neighborhoods">
    <option data-tokens="Bayview Hunters Point" value = "Bayview Hunters Point">Bayview Hunters Point</option>
    <option data-tokens="Bernal Heights" value = "Bernal Heights">Bernal Heights</option>
    <option data-tokens="Castro/Upper Market" value = "Castro/Upper Market">Castro/Upper Market</option>
    <option data-tokens="Chinatown" value = "Chinatown">Chinatown</option>
    <option data-tokens="Excelsior" value = "Excelsior">Excelsior</option>
    <option data-tokens="Financial District/South Beach" value = "Financial District/South Beach">Financial District/South Beach</option>
    <option data-tokens="Glen Park" value = "Glen Park">Glen Park</option>
    <option data-tokens="Golden Gate Park" value = "Golden Gate Park">Golden Gate Park</option>
    <option data-tokens="Haight Ashbury" value = "Haight Ashbury">Haight Ashbury</option>
    <option data-tokens="Hayes Valley" value = "Hayes Valley">Hayes Valley</option>
    <option data-tokens="Inner Richmond" value = "Inner Richmond">Inner Richmond</option>
    <option data-tokens="Inner Sunset" value = "Inner Sunset">Inner Sunset</option>
    <option data-tokens="Japantown" value = "Japantown">Japantown</option>
    <option data-tokens="Lakeshore" value = "Lakeshore">Lakeshore</option>
    <option data-tokens="Lincoln Park" value = "Lincoln Park">Lincoln Park</option>
    <option data-tokens="Lone Mountain/USF" value = "Lone Mountain/USF">Lone Mountain/USF</option>
    <option data-tokens="Marina" value = "Marina">Marina</option>
    <option data-tokens="McLaren Park" value = "McLaren Park">McLaren Park</option>
    <option data-tokens="Mission" value = "Mission">Mission</option>
    <option data-tokens="Mission Bay" value = "Mission Bay">Mission Bay</option>
    <option data-tokens="Nob Hill" value = "Nob Hill">Nob Hill</option>
    <option data-tokens="Noe Valley" value = "Noe Valley">Noe Valley</option>
    <option data-tokens="North Beach" value = "North Beach">North Beach</option>
    <option data-tokens="Oceanview/Merced/Ingleside" value = "Oceanview/Merced/Ingleside">Oceanview/Merced/Ingleside</option>
    <option data-tokens="Outer Mission" value = "Outer Mission">Outer Mission</option>
    <option data-tokens="Outer Richmond" value = "Outer Richmond">Outer Richmond</option>
    <option data-tokens="Pacific Heights" value = "Pacific Heights">Pacific Heights</option>
    <option data-tokens="Portola" value = "Portola">Portola</option>
    <option data-tokens="Potrero Hill" value = "Potrero Hill">Potrero Hill</option>
    <option data-tokens="Presidio" value = "Presidio">Presidio</option>
    <option data-tokens="Presidio Heights" value = "Presidio Heights">Presidio Heights</option>
    <option data-tokens="Russian Hill" value = "Russian Hill">Russian Hill</option>
    <option data-tokens="Seacliff" value = "Seacliff">Seacliff</option>
    <option data-tokens="South of Market" value = "South of Market">South of Market</option>
    <option data-tokens="Sunset/Parkside" value = "Sunset/Parkside">Sunset/Parkside</option>
    <option data-tokens="Tenderloin" value = "Tenderloin">Tenderloin</option>
    <option data-tokens="Treasure Island" value = "Treasure Island">Treasure Island</option>
    <option data-tokens="Twin Peaks" value = "Twin Peaks">Twin Peaks</option>
    <option data-tokens="Visitacion Valley" value = "Visitacion Valley">Visitacion Valley</option>
    <option data-tokens="Western Addition" value = "Western Addition">Western Addition</option>
    <option data-tokens="West of Twin Peaks" value = "West of Twin Peaks">West of Twin Peaks</option>
    </optgroup>
    <optgroup label="Priority Development Areas">
    <option data-tokens="19th Avenue" value = "19th Avenue">19th Avenue</option>
    <option data-tokens="Balboa Park" value = "Balboa Park">Balboa Park</option>
    <option data-tokens="Bayview/Hunters Point Shipyard/Candlestick Point" value = "Bayview/Hunters Point Shipyard/Candlestick Point">Bayview/Hunters Point Shipyard/Candlestick Point</option>
    <option data-tokens="Downtown-Van Ness-Geary" value = "Downtown-Van Ness-Geary">Downtown-Van Ness-Geary</option>
    <option data-tokens="Eastern Neighborhoods" value = "Eastern Neighborhoods">Eastern Neighborhoods</option>
    <option data-tokens="Market & Octavia" value = "Market & Octavia">Market & Octavia</option>
    <option data-tokens="Mission Bay" value = "Mission Bay">Mission Bay</option>
    <option data-tokens="Mission-San Jose Corridor" value = "Mission-San Jose Corridor">Mission-San Jose Corridor</option>
    <option data-tokens="Port of San Francisco" value = "Port of San Francisco">Port of San Francisco</option>
    <option data-tokens="Transit Center District" value = "Transit Center District">Transit Center District</option>
    <option data-tokens="Treasure Island & Yerba Buena Island" value = "Treasure Island & Yerba Buena Island">Treasure Island & Yerba Buena Island</option>
  </select>
  </br>
  <button onclick="showCombined2();">Update Map</button>
  </br></br><b> Or by Address </b>
  <form id ='address_input'>
      Distance (In Miles): <input type='text' value = ''></input>
  </br>Address:<input type='text' value = ''></input>
  </form>
  </br><button onclick="addressSearch();">Update Map</button>
  </div>
  </div>
  
<script type="text/javascript">
	
    //Initiate bounds variables
    var bounds =  null;
	//initiating with very wide bounds to return everything
    var lower_bound = -100;
    var upper_bound = 3000;
	//Initiate status vars
	var proj_status = null;
    var place_name = null;
  
 // create the Leaflet map container
  var map = L.map('map').setView([37.767, -122.441042], 12.5);
  
  //add tile layer basemap to the map
  var basemapUrl = 'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png';
  var basemapAttribution = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>';
  var basemapProperties = {minZoom: 2, maxZoom: 16, attribution: basemapAttribution};
  L.tileLayer(basemapUrl, basemapProperties).addTo(map);
  
// Global Variables
// Will go here
var projects = null;
//specify what the circle markers should look like (radius and fill color are dynamically set later)
var markerStyle = {radius: null, fillOpacity: 0.7, color: '#666666', opacity: 1, weight: 1, fillColor: null};
  
if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
	var initialZoomLevel = 12;
} else {
	var initialZoomLevel = 10;
}
  
function getRadius() {
	//Make dots bigger if viewed on mobile
	if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
	    if (map.getZoom()) { radius = Math.pow(map.getZoom(), 0.9); } //if map already exists, get current zoom level
	    else { radius = Math.pow(initialZoomLevel, 0.9); } //if it's the initial startup, use initial zoom level
	    return radius;
	} else {
	    if (map.getZoom()) { radius = Math.pow(map.getZoom(), 0.8); } //if map already exists, get current zoom level
	    else { radius = Math.pow(initialZoomLevel, 0.8); } //if it's the initial startup, use initial zoom level
	    return radius;
	}	
}
  
  
// function to add data points to map layer with proper styling
function pointToLayer(feature, latlng) {
		markerStyle.fillColor = '#666666';
		markerStyle.radius = getRadius();
        return L.circleMarker(latlng, markerStyle);
}
  
  

//test aggregate query (aggregate dots by polygons)
//Aggregate dots by various polygons
var aggregate_query = "SELECT pdas.name, pdas.the_geom, sum(current_data.net_units) FROM current_data, pdas WHERE ST_Intersects(current_data.the_geom, pdas.the_geom) GROUP BY pdas.name, pdas.the_geom";
  
  
  //test POSTGIS to select projects in the Mission Neighborhood (41 Neighborhoods shapefile)
//This one works. Have to explicitly list columns because some columns are ambiguous between two datasets (?)
var nhb_query = "SELECT current_data.address, current_data.the_geom FROM current_data, (SELECT * FROM table_41_neighborhoods WHERE nhood = 'Mission') AS dd_nc WHERE ST_Intersects(current_data.the_geom, dd_nc.the_geom)";


//Reverse of the above, seems to return every polygon. Interesting...
//var mission_query = "SELECT table_41_neighborhoods.the_geom FROM table_41_neighborhoods, (SELECT * FROM current_data) AS dd_nc WHERE ST_Intersects(dd_nc.the_geom, table_41_neighborhoods.the_geom)";
  
  //Query by closest 5 dots to a give point (Web Mercator Projection)
  var closest_query = "SELECT * FROM current_data ORDER BY ST_SetSRID(the_geom, 4326) <-> ST_SetSRID(ST_MakePoint(-122.424777, 37.764063), 4326) LIMIT 5";
  
  // Get all development projects from dataset
  var sqlQuery = "SELECT * FROM current_data";







  // Set CartoDB Username
  var cartoDBUserName = "bgoggin";
  // Function to add call coffee shops
  // Get CartoDB selection as GeoJSON and Add to Map
  function showAll(){
    $.getJSON("https://"+cartoDBUserName+".cartodb.com/api/v2/sql?format=GeoJSON&q="+sqlQuery, function(data) {
      projects = L.geoJson(data, {pointToLayer: pointToLayer}).addTo(map);
    });
  };
  
  
  function showClosest() {
	  if (map.hasLayer(projects)) {
		  map.removeLayer(projects);
	  };
      $.getJSON("https://"+cartoDBUserName+".cartodb.com/api/v2/sql?format=GeoJSON&q="+closest_query, function(data) {
        projects = L.geoJson(data, {pointToLayer: pointToLayer}).addTo(map);
      });
	
  }
  
  function showAggregate() {
	  if (map.hasLayer(projects)) {
		  map.removeLayer(projects);
	  };
      $.getJSON("https://"+cartoDBUserName+".cartodb.com/api/v2/sql?format=GeoJSON&q="+aggregate_query, function(data) {
        projects = L.geoJson(data, {pointToLayer: pointToLayer}).addTo(map);
      });
	
  }
  
  function addressSearch() {
      var input = document.getElementById("address_input").children;
      var distance = input[0].value.toString();
      var conversion_factor = "*1609.34"; //convert from miles to meters
      var address = input[2].value.toString();
      var openStreetMapGeocoder = GeocoderJS.createGeocoder('openstreetmap');
      openStreetMapGeocoder.geocode(address+', San Francisco, CA', function(result) {
            var lat = result[0]['latitude'];
            var lon = result[0]['longitude'];
            
            //Query by dots around above lat lon. Return all points within 0.25 miles (402.336 meters)
            var closest_query = "SELECT * FROM current_data WHERE ST_Distance(ST_SetSRID(the_geom::geography, 4326), ST_SetSRID(ST_MakePoint(" + lon + "," + lat + ")::geography, 4326)) <= " + distance + conversion_factor;
          	if (map.hasLayer(projects)) {
          		map.removeLayer(projects);
          	};
            
            $.getJSON("https://"+cartoDBUserName+".cartodb.com/api/v2/sql?format=GeoJSON&q="+closest_query, function(data) {
              projects = L.geoJson(data, {pointToLayer: pointToLayer, onEachFeature: onEachFeature}).addTo(map);
            });

            map.setView([lat, lon], 15);
            });
  }
   
  function showCombined2() {
      
	  //Get unit bounds from user selections
	  bounds = document.getElementById("unit_bounds").children;
	  lower_bound = bounds[0].value;
	  upper_bound = bounds[2].value;
      if (lower_bound != '' && upper_bound != '') {
          var unit_query = "AND net_units BETWEEN " + lower_bound.toString() + " AND " + upper_bound.toString();
      } else if (lower_bound == '' && upper_bound !='') {
          var unit_query = "AND net_units <= " + upper_bound.toString();
      } else if (lower_bound != '' && upper_bound =='') {
          var unit_query = "AND net_units >= " + lower_bound.toString();
      } else {
          var unit_query = "";
      }
      
	  //Get project status from user selections
	  proj_status = document.getElementById("statusSelect").value;
	  if (proj_status == 'All') {
	  	var statusvar = "";
	  }
	  else {
	  	var statusvar = "AND status = '" + proj_status + "'";
	  }
      
	  //Get place name filter
	  place_name = document.getElementById("placeSelect").value;
	  if (place_name == 'All') {
	  	var placevar = "(SELECT * FROM table_41_neighborhoods)";
	  }
	  else {
	  	var placevar = "(SELECT * FROM table_41_neighborhoods WHERE nhood = '" + place_name + "')";
	  }
	  
	  if (map.hasLayer(projects)) {
		  map.removeLayer(projects);
	  };
	  var combined_query = "SELECT cd.address, cd.net_units, cd.status, cd.the_geom FROM current_data AS cd," + placevar + " AS dd_nc WHERE ST_Intersects(cd.the_geom, dd_nc.the_geom) " + unit_query + statusvar;
      $.getJSON("https://"+cartoDBUserName+".cartodb.com/api/v2/sql?format=GeoJSON&q="+combined_query, function(data) {
        projects = L.geoJson(data, {pointToLayer: pointToLayer, onEachFeature: onEachFeature}).addTo(map);
      });
  }
  
  
function onEachFeature(feature, layer) {
    layer.on({
		click: clickFeature
    });
}

//on click, pan/zoom to feature and show popup
function clickFeature(e) {
    var target = e.target;
    var latlng = target._latlng;
    var props = target.feature.properties;

	var popupContent ='<span class="popup-label"><b>' + props.address + '</b></span>' +
    '<br /><span class="popup-label">Net Units: ' + props.net_units + '</span>' +
    '<br /><span class="popup-label">Status: ' + props.status + '</span>';
	 
    var popup = L.popup({closeOnClick: false}).setContent(popupContent).setLatLng(latlng);
    target.bindPopup(popup).openPopup(); 
	
}
  
  // Run showAll function automatically when document loads
  $(document).ready(function() {
    showAll();
  });
  
</script>

</body>
</html>